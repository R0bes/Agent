networks:
  agent-network:
    name: agent-network
    driver: bridge

services:
  agent-core:
    container_name: api
    build: 
      context: .
      dockerfile: agent/Dockerfile
    ports:
      - "8000:8000"
    environment:
      PYTHONUNBUFFERED: 1
      LLM_PROVIDER: ollama
      LLM_BASE_URL: http://host.docker.internal:11434
      LLM_MODEL: gpt-oss:20b
    volumes:
      - ./logs:/app/logs
    restart: unless-stopped
    networks:
      - agent-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agent-core.rule=Host(`localhost`) || Host(`127.0.0.1`) && (PathPrefix(`/api`) || Path(`/health`) || Path(`/think`))"
      - "traefik.http.routers.agent-core.entrypoints=web"
      - "traefik.http.services.agent-core.loadbalancer.server.port=8000"

  agent-ui:
    container_name: ui
    build:
      context: ./ui
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - agent-core
    restart: unless-stopped
    networks:
      - agent-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.agent-ui.rule=Host(`localhost`) || Host(`127.0.0.1`)"
      - "traefik.http.routers.agent-ui.entrypoints=web"
      - "traefik.http.services.agent-ui.loadbalancer.server.port=3000"

  traefik:
    image: traefik:v2.10
    container_name: traefik
    ports:
      - "80:80"   # HTTP (wird zu HTTPS weitergeleitet)
      - "443:443" # HTTPS
      - "8080:8080" # Traefik Dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infrastructure/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./infrastructure/traefik/dynamic:/etc/traefik/dynamic:ro
    # Traefik-Labels entfernt - Router werden jetzt direkt in der Traefik-Konfiguration definiert
    networks:
      - agent-network
    restart: unless-stopped
    # Traefik-Labels entfernt - Router werden jetzt direkt in der Traefik-Konfiguration definiert

  # WhatsApp Bot Service
#  whatsapp-bot:
#    container_name: whatsapp-bot
#    build:
#      context: .
#      dockerfile: adapter/whatsapp_bot/Dockerfile
#    environment:
#      - PYTHONUNBUFFERED=1
#      - WHATSAPP_HEADLESS=true
#      - WHATSAPP_MAX_RETRIES=3
#      - WHATSAPP_RETRY_DELAY=5
#      - WHATSAPP_MONITORING_INTERVAL=3
#      - BOT_TYPE=whatsapp
#      - API_HOST=0.0.0.0
#      - API_PORT=8001
#    ports:
#      - "8001:8001"
#    volumes:
#      - ./agent:/app/agent
#      - ./adapter:/app/adapter
#      - ./logs:/app/logs
#      - /tmp/.X11-unix:/tmp/.X11-unix:rw
#    depends_on:
#      - agent-core
#      - chrome
#    restart: unless-stopped
#    networks:
#      - agent-network
#    command: ["python", "-m", "adapter.whatsapp_bot.whatsapp_bot_interface"]
#    labels:
#      - "traefik.enable=true"
#      - "traefik.http.routers.whatsapp-bot.rule=Host(`whatsapp.${DOMAIN:-localhost}`)"
#      - "traefik.http.routers.whatsapp-bot.entrypoints=websecure"
#      - "traefik.http.routers.whatsapp-bot.middlewares=cors@file"
#      - "traefik.http.services.whatsapp-bot.loadbalancer.server.port=8001"
#      - "traefik.http.routers.whatsapp-bot.tls=true"
#
#  # Telegram Bot Service
#  telegram-bot:
#    container_name: telegram-bot
#    build:
#      context: .
#      dockerfile: adapter/telegram_bot/Dockerfile
#    environment:
#      - TELEGRAM_TOKEN=${TELEGRAM_BOT_TOKEN}
#      - TELEGRAM_WEBHOOK_URL=${TELEGRAM_WEBHOOK_URL}
#      - TELEGRAM_POLLING=true
#      - BOT_TYPE=telegram
#      - API_HOST=0.0.0.0
#      - API_PORT=8002
#    ports:
#      - "8002:8002"
#    volumes:
#      - ./agent:/app/agent
#      - ./adapter:/app/adapter
#      - ./logs:/app/logs
#    depends_on:
#      - agent-core
#    restart: unless-stopped
#    networks:
#      - agent-network
#    command: ["python", "-m", "adapter.telegram_bot.telegram_bot_interface"]
#    labels:
#      - "traefik.http.routers.telegram-bot.rule=Host(`telegram.${DOMAIN:-localhost}`)"
#      - "traefik.http.routers.telegram-bot.entrypoints=websecure"
#      - "traefik.http.routers.telegram-bot.middlewares=cors@file"
#      - "traefik.http.services.telegram-bot.loadbalancer.server.port=8002"
#      - "traefik.http.routers.telegram-bot.tls=true"

